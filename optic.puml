@startuml
allow_mixing

!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v20.0/dist
!include AWSPuml/AWSCommon.puml
!include AWSPuml/Groups/AWSCloud.puml
!include AWSPuml/Groups/Region.puml
!include AWSPuml/Groups/VPC.puml
!include AWSPuml/Groups/PublicSubnet.puml
!include AWSPuml/Groups/PrivateSubnet.puml
!include AWSPuml/NetworkingContentDelivery/Route53.puml
!include AWSPuml/NetworkingContentDelivery/Route53HostedZone.puml
!include AWSPuml/NetworkingContentDelivery/ElasticLoadBalancingApplicationLoadBalancer.puml
!include AWSPuml/NetworkingContentDelivery/VPCInternetGateway.puml
!include AWSPuml/NetworkingContentDelivery/VPCNATGateway.puml
!include AWSPuml/Containers/ElasticContainerService.puml
!include AWSPuml/Containers/ElasticContainerServiceService.puml
!include AWSPuml/Compute/EC2AutoScaling.puml
!include AWSPuml/Database/AuroraMariaDBInstance.puml
!include AWSPuml/Storage/SimpleStorageService.puml
!include AWSPuml/ManagementGovernance/CloudWatch.puml
!include AWSPuml/General/Internetalt1.puml

' Custom generic icon for Datadog
!include https://raw.githubusercontent.com/plantuml-stdlib/gilbarbara-plantuml-sprites/master/sprites/datadog.puml

left to right direction

Internetalt1(user, "User", "HTTPS")

AWSCloudGroup(cloud) {
RegionGroup(region, "us-east-1") {

' Global/Region Level
Route53HostedZone(dns, "Route 53", "dev.complianceview360.io")
SimpleStorageService(s3_logs, "S3 Bucket", "ALB Access Logs")

VPCGroup(vpc, "VPC (10.0.0.0/16)") {

    ' Gateways
    VPCInternetGateway(igw, "Internet Gateway", "Public Access")

    ' Public Subnets (us-east-1a/b)
    PublicSubnetGroup(pub_net, "Public Subnets (/20)") {
        ElasticLoadBalancingApplicationLoadBalancer(alb, "ALB", "Public Ingress")
        VPCNATGateway(nat, "NAT Gateway", "Outbound Connectivity")
    }

    ' Private Subnets (us-east-1a/b)
    PrivateSubnetGroup(priv_net, "Private Subnets (/20)") {

        ' Compute Layer
        rectangle "ECS Cluster (Fargate/EC2)" as cluster_box {
            EC2AutoScaling(asg, "Auto Scaling Grp", "Capacity Provider")
            ElasticContainerService(ecs_cluster, "ECS Cluster", "Orchestrator")

            ElasticContainerServiceService(svc_modx, "MODX", "Path: /")
            ElasticContainerServiceService(svc_laravel, "Laravel", "Path: /app")
            ElasticContainerServiceService(svc_dd, "Datadog Agent", "Daemon Service")
        }

        ' Database Layer
        AuroraMariaDBInstance(db, "RDS MariaDB", "Single AZ (Port 3306)")
    }
}

' Monitoring
CloudWatch(cw, "CloudWatch", "Logs & Metrics")
}

}

' Connectivity Relationships
user --> dns : " Resolves Domain"
dns --> alb : " Traffic"
alb --> svc_modx : " Route /"
alb --> svc_laravel : " Route /app"

' Network Relationships
pub_net -[hidden]-> igw
priv_net -[hidden]-> nat
pub_net --> igw : " Internet Access"
svc_modx --> nat : " Outbound"
svc_laravel --> nat : " Outbound"

' Database Relationships
svc_modx --> db : " SQL (3306)"
svc_laravel --> db : " SQL (3306)"

' Scaling Relationship
ecs_cluster -l-> asg : " Scaling/Capacity"

rectangle "Datadog" as datadog <<$datadog>>

' Observability Relationships
alb -.-> s3_logs : " Access Logs"
svc_modx -.-> cw : " App Logs"
svc_laravel -.-> cw : " App Logs"
' svc_dd -.-> datadog_saas : " Metrics/Logs"
cw -.-> datadog : " Forwarding"

@enduml
